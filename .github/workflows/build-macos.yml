name: build-macos
on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  build:
    name: ${{ matrix.config.name }}
    strategy:
      matrix:
        config:
        - {
            name: "macOS-10.13-x64", artifact: "macOS-10.13-x64.zip",
            os: macos-latest
          }
    runs-on: ${{ matrix.config.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        host: 'mac'
        target: 'desktop'
        install-deps: 'true'
        cache: ${{ steps.cache-qt.outputs.cache-hit }}
    - name: Dump Qt DIR
      run:  echo ${Qt5_DIR}

    - name: Init submodules
      run: git submodule init && git submodule update
    - name: Configure build
      run: |
        find ${Qt5_DIR}/lib/cmake -maxdepth 1
        mkdir -p build
        cd build
        cmake .. \
          -DBUILD_DEPENDENCIES=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_DEPLOYMENT_TARGET="10.13" \
          -DCMAKE_PREFIX_PATH=${Qt5_DIR} \
          -DQt5Core_DIR=${Qt5_DIR}/lib/cmake/Qt5Core \
          -DQt5Gui_DIR=${Qt5_DIR}/lib/cmake/Qt5Gui \
          -DQt5Qml_DIR=${Qt5_DIR}/lib/cmake/Qt5Qml \
          -DQt5Network_DIR=${Qt5_DIR}/lib/cmake/Qt5Network \
          -DQt5Quick_DIR=${Qt5_DIR}/lib/cmake/Qt5Quick \
          -DQt5QuickControls2_DIR=${Qt5_DIR}/lib/cmake/Qt5QuickControls2 \
          -DQt5Xml_DIR=${Qt5_DIR}/lib/cmake/Qt5Xml \
          -DQt5Svg_DIR=${Qt5_DIR}/lib/cmake/Qt5Svg \
          -DQt5Widgets_DIR=${Qt5_DIR}/lib/cmake/Qt5Widgets

    - name: Build from sources
      run: |
        cd build
        make

    - name: Build package
      run: |
        export QT_DIR=${Qt5_DIR}
        export SOURCE_DIR=${{ github.workspace }}
        export BUILD_DIR=${{ github.workspace }}/build
        cd ${BUILD_DIR}
        ${SOURCE_DIR}/macosx/bundle.sh icon
        ${SOURCE_DIR}/macosx/bundle.sh bundle
        ${SOURCE_DIR}/macosx/bundle.sh archive

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.config.name }}
        path: ${{ github.workspace }}/build/noson-MacOSX_*.tar.gz
        retention-days: 5

